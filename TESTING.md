# Testing Documentation

This document provides an overview of the testing infrastructure for the PhotoIdentifier platform.

## Test Frameworks

### Vitest (Unit Tests)
- **Framework**: Vitest with React Testing Library
- **Purpose**: Unit testing of frontend utilities and components
- **Location**: `packages/utils/__tests__/`, `apps/web/__tests__/`
- **Config**: `vitest.config.ts`

### Pytest (Integration Tests)
- **Framework**: Pytest with async support
- **Purpose**: Integration testing of FastAPI backend and API endpoints
- **Location**: `tests/integration/`, `tests/unit/`
- **Config**: `pytest.ini`

## Running Tests

### Vitest (Frontend)

```bash
# Run all tests once
npm test

# Run tests in watch mode
npm run test:watch

# Generate coverage report
npm run test:coverage

# Run tests with UI
npm run test:ui
```

### Pytest (Backend)

```bash
# Install test dependencies
pip install -r requirements-test.txt

# Run all tests
pytest

# Run with verbose output
pytest -v

# Run specific test file
pytest tests/integration/test_api.py

# Run with coverage
pytest --cov=.

# Run only unit tests
pytest -m unit

# Run only integration tests
pytest -m integration

# Run tests in parallel
pytest -n auto

# Run tests marked as fast (skip slow tests)
pytest -m "not slow"
```

## Test Organization

```
tests/
├── conftest.py              # Pytest fixtures and configuration
├── unit/                    # Unit tests
│   └── test_utils.py       # Utility function tests
├── integration/            # Integration tests
│   └── test_api.py        # API endpoint tests
└── __init__.py

packages/utils/__tests__/    # Vitest unit tests
├── formatting.test.ts
├── validation.test.ts
├── photo.test.ts
└── array.test.ts
```

## Test Markers

Pytest uses markers to categorize tests:

- `@pytest.mark.integration`: Integration tests requiring services
- `@pytest.mark.unit`: Pure unit tests
- `@pytest.mark.slow`: Slow tests that may take longer
- `@pytest.mark.asyncio`: Async tests

## Fixtures

### Pytest Fixtures (in `tests/conftest.py`)

- `async_client`: Async HTTP client for API testing
- `sync_client`: Sync HTTP client for API testing
- `db_session`: Database session with auto-rollback
- `test_user_token`: Valid auth token for tests
- `test_headers`: Headers with auth token
- `sample_photo_data`: Sample photo data
- `sample_identification_data`: Sample AI identification data
- `mock_ai_response`: Mock AI model response

## Coverage

### Vitest Coverage

Coverage reports are generated in `coverage/` directory:
- HTML report: `coverage/index.html`
- JSON report: `coverage/coverage-final.json`

### Pytest Coverage

Coverage reports are generated by pytest-cov:
- Terminal output: displayed after test run
- HTML report: `htmlcov/index.html`
- Fail if coverage < 80%

## Best Practices

### Writing Tests

1. **Unit Tests**: Test isolated functions without dependencies
2. **Integration Tests**: Test API endpoints with database
3. **Async Tests**: Use `@pytest.mark.asyncio` decorator
4. **Fixtures**: Use fixtures for common test data
5. **Markers**: Use appropriate markers for test categorization

### Test Data

1. Use factories (Faker) for realistic test data
2. Create isolated test databases
3. Clean up after each test
4. Use transactions that roll back

### Performance

1. Run slow tests separately with `-m "slow"`
2. Use parallel execution with `-n auto`
3. Set timeouts for hanging tests
4. Mock external API calls

## CI/CD Integration

Tests run automatically on:
- Pull requests
- Push to main branch
- Scheduled runs

Test results are reported in:
- GitHub Actions tab
- Pull request checks
- Coverage reports

## Troubleshooting

### Vitest Issues

```bash
# Clear cache
rm -rf node_modules/.vite

# Reinstall dependencies
npm install
```

### Pytest Issues

```bash
# Clear Python cache
find . -type d -name __pycache__ -exec rm -rf {} +
find . -type f -name "*.pyc" -delete

# Reinstall test dependencies
pip install --force-reinstall -r requirements-test.txt
```

## Adding New Tests

### Vitest Test

```typescript
// packages/utils/__tests__/my-feature.test.ts
import { describe, it, expect } from 'vitest';
import { myFunction } from '../src';

describe('myFunction', () => {
  it('should do something', () => {
    expect(myFunction()).toBe('expected');
  });
});
```

### Pytest Test

```python
# tests/unit/test_my_feature.py
def test_my_feature():
    """Test my feature."""
    from app.utils import my_function
    
    result = my_function()
    assert result == "expected"
```

## Resources

- [Vitest Documentation](https://vitest.dev/)
- [Pytest Documentation](https://docs.pytest.org/)
- [React Testing Library](https://testing-library.com/react)
- [FastAPI Testing](https://fastapi.tiangolo.com/tutorial/testing/)
